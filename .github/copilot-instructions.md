# Copilot Instructions for GH-Actions

## Project Overview

**GH-Actions** is a GitHub Action that manages OAuth token lifecycle for GitHub Apps. It refreshes expired user access tokens, app installation tokens, and securely stores them as repository secrets using libsodium encryption.

**Key Purpose**: Automated token refresh and secret management for GitHub App OAuth workflows.

## Architecture & Data Flow

### Core Components

1. **`src/refreshToken.ts`** (Main entry point)
   - Orchestrates the entire token refresh workflow
   - Accepts inputs: `token`, `userRefreshToken`, `privateKey`, `clientId`, `clientSecret`, `appId`
   - Outputs encrypted tokens to GitHub repository secrets

2. **Token Validation → Refresh → Secret Update Flow**
   ```
   generateJWT(appId, privateKey)
       ↓
   getAppInstallId(jwt)
       ↓
   getPublicKey(repo) → Fetch repo's public key
       ↓
   app.oauth.checkToken(token) OR app.oauth.refreshToken(refreshToken)
       ↓
   updateSecret() → Encrypt with libsodium & store secret
   ```

3. **Encryption Pattern** (`updateSecret()`)
   - Fetches repo's public key via GitHub API
   - Encrypts token with `libsodium.crypto_box_seal()` (sealed box encryption)
   - Encodes encrypted value in base64
   - Stores as `APP_ACCESS_TOKEN`, `USER_ACCESS_TOKEN`, `USER_REFRESH_TOKEN`

### Key Libraries

- **`@octokit/app`**: OAuth flow, token validation/refresh
- **`@actions/core`**: GitHub Action inputs/outputs
- **`jsonwebtoken`**: JWT generation for app authentication (RS256 with 10-min expiry)
- **`libsodium-wrappers`**: Sealed box encryption for secrets

## Build & Test Workflow

### Commands
- `npm run build` → TypeScript compilation (`src/` → `lib/`)
- `npm run package` → Bundle with `@vercel/ncc` (`lib/refreshToken.js` → `dist/index.js`)
- `npm run build:package` → Both steps
- `npm run test` → Build + package + run locally with `gh act` (requires `.secrets` file with GitHub token)

### Action Structure (GitHub Actions JavaScript Action Pattern)
This project follows the standard GitHub Actions JavaScript action structure:
```
src/                    ← TypeScript source (readable, maintainable)
├── refreshToken.ts     ← Main action logic
lib/                    ← Compiled JavaScript (generated by tsc)
├── refreshToken.js
dist/                   ← Bundled action (generated by @vercel/ncc)
├── index.js            ← Entry point specified in action.yml
action.yml              ← Metadata defining inputs/outputs/entry point
```

**Why bundle to `dist/index.js`?** 
- GitHub Actions downloads the bundled file at runtime; no `node_modules` dependency shipping needed
- `@vercel/ncc` bundles all dependencies into a single file for fast, portable execution
- This matches GitHub's recommended pattern for JavaScript actions

### Important Notes
- **Action Entry Point**: `dist/index.js` (compiled & bundled from `lib/refreshToken.js`)
- **Node Version**: node24 (specified in `action.yml`)
- **Test Environment**: Uses `gh act` to simulate GitHub Actions locally with `linux/amd64` architecture
- **Rebuild Required**: After any TypeScript changes, run `npm run build && npm run package` before testing/deploying
- **Commit `dist/index.js`**: Always commit the bundled file; GitHub Actions consumers depend on it

## Project Conventions & Patterns

### Error Handling
- Heavily nested try-catch blocks; some error handling seems defensive but loosely structured
- Failed token refresh calls `setFailed()` with error message
- Debug logging via `@actions/core` debug() throughout for troubleshooting

### Testing Context
- Special handling for local testing: checks `if (context.actor === "nektos/act")` to detect local test runs
- This allows separate logic for GitHub Actions vs. local development

### Secrets Management
- Secrets are encrypted before storage (not stored in plaintext)
- Uses GitHub's repository public key infrastructure
- Three secrets typically managed: `APP_ACCESS_TOKEN`, `USER_ACCESS_TOKEN`, `USER_REFRESH_TOKEN`

## Important Implementation Details

1. **JWT Expiry**: 10 minutes (generated fresh each run with 60-second clock skew buffer)
2. **App Identification**: Hardcoded check for `app_slug === "actions-pr-approval"` when retrieving installation ID
3. **OAuth Endpoints**: Uses GitHub's OAuth token validation and refresh endpoints
4. **API Version**: Explicitly sets `X-GitHub-Api-Version: 2022-11-28` on REST API calls

## When Adding/Modifying Code

- Keep token refresh logic in `src/refreshToken.ts`; recompile and rebundle after changes
- All user/app inputs come from `@actions/core` `getInput()` calls
- All outputs must use `@actions/core` `setOutput()` for GitHub Actions consumption
- Use debug logging for troubleshooting; errors should call `setFailed()`
- Remember to run security scans (Snyk) per security instructions

## File References

- **Source**: `src/` (TypeScript)
- **Compiled**: `lib/` (JavaScript)
- **Bundled Action**: `dist/index.js` (entry point)
- **Config**: `action.yml` (action metadata), `tsconfig.json` (build config)
- **Example Usage**: `example-commands/curl-examples.sh`
